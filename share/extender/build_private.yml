
# build_private.yml

# todo: Improve the merging of this file (e.g. using yaml -> dicts -> merged dict -> yaml)
  arm64-nx64:
    env:
        SDK:            "{{env.NINTENDO_SDK_ROOT}}"
        CLANG:          "{{env.NINTENDO_SDK_ROOT}}/Compilers/NX/nx/aarch64/bin/clang++.exe"
        AR:             "{{env.NINTENDO_SDK_ROOT}}/Compilers/NX/nx/aarch64/bin/llvm-ar.exe"
        MAKENSO:        "{{env.NINTENDO_SDK_ROOT}}/Tools/CommandLineTools/MakeNso/MakeNso.exe"
        MAKEMETA:       "{{env.NINTENDO_SDK_ROOT}}/Tools/CommandLineTools/MakeMeta/MakeMeta.exe"
        LDSCRIPT:       "{{env.NINTENDO_SDK_ROOT}}/Resources/SpecFiles/Application.aarch64.lp64.ldscript"
        TRIPLET:        "aarch64-nintendo-nx-elf"
    context:
        excludeSymbols:     ["WebViewExt", "IAPExt", "IACExt", "PushExt", "FacebookExt", "GraphicsAdapterOpenGL"]
        symbols:            ["AudioDecoderStbVorbis", "GraphicsAdapterVulkan"]
        engineLibs:         ["engine", "engine_service", "mbedtls", "zip", "profilerext", "record_null", "gameobject", "ddf", "resource", "gamesys", "graphics_vulkan", "graphics_transcoder_basisu", "basis_transcoder", "physics_2d", "Box2D", "render", "script", "luajit-5.1", "extension", "hid", "input", "particle", "rig", "dlib", "gui", "crashext", "sound", "liveupdate"]
        libPaths:           ["{{dynamo_home}}/lib/arm64-nx64", "{{dynamo_home}}/ext/lib/arm64-nx64"]
        defines:            ["DM_PLATFORM_SWITCH", "LUA_BYTECODE_ENABLE_64", "NN_ENABLE_LOG", "NN_ENABLE_ASSERT", "NN_ENABLE_ABORT_MESSAGE", "NN_NINTENDO_SDK", "NN_SDK_BUILD_DEBUG"]
        platformIncludes:   ["{{env.SDK}}/Common/Configs/Targets/NX-NXFP2-a64/Include", "{{env.SDK}}/Include"]
        flags:              ["-g", "-O2", "-fno-exceptions", "-fvisibility=hidden","-Werror=format","-fPIC"]
        linkFlags:          ["--gc-sections","--build-id=sha1","-init=_init","-fini=_fini","-pie","-z,combreloc","-z,relro","--enable-new-dtags","-u,malloc","-u,calloc","-u,realloc","-u,aligned_alloc","-u,free"]
        objectFiles:        ["{{env.SDK}}/Libraries/NX-NXFP2-a64/Release/rocrt.o",
                             "{{env.SDK}}/Libraries/NX-NXFP2-a64/Release/nnApplication.o",
                             "{{env.SDK}}/Libraries/NX-NXFP2-a64/Release/libnn_init_memory.a",
                             "{{env.SDK}}/Libraries/NX-NXFP2-a64/Release/libnn_gll.a",
                             "{{env.SDK}}/Libraries/NX-NXFP2-a64/Release/libnn_gfx.a",
                             "{{env.SDK}}/Libraries/NX-NXFP2-a64/Release/libnn_mii_draw.a",
                             "{{env.SDK}}/Libraries/NX-NXFP2-a64/Release/vulkan.nss",
                             "{{env.SDK}}/Libraries/NX-NXFP2-a64/Release/opengl.nss",
                             "{{env.SDK}}/Libraries/NX-NXFP2-a64/Release/nnSdkEn.nss",
                             "{{env.SDK}}/Libraries/NX-NXFP2-a64/Release/crtend.o"]

    exePrefix: 'lib'
    exeExt: '.so'
    shlibRe: 'lib(.+).so'
    stlibRe: 'lib(.+).a'
    sourceRe: '(?i).+(\.cpp|\.c|\.cc|\.cxx|\.c\+\+)$'
    writeLibPattern: 'lib%s.a'
    writeExePattern: 'dmengine'
    zipContentPattern: 'dmengine.(nss|nso)'
    allowedLibs:    ["(\\w[\\w\\.+-]+)"]
    allowedFlags:  ["-(\\w[\\w\\.+-]+)"]
    compileCmd:     'wine {{env.CLANG}} --target={{env.TRIPLET}} {{#flags}}{{{.}}} {{/flags}} {{#defines}}-D{{{.}}} {{/defines}} {{#ext.includes}}-I{{{.}}} {{/ext.includes}} {{#includes}}-I{{{.}}} {{/includes}} {{#platformIncludes}}-I{{{.}}} {{/platformIncludes}}  -c {{src}} -o{{tgt}}'
    linkCmds:       ['wine {{env.CLANG}} {{#src}}{{{.}}} {{/src}} -o {{tgt}}.nss -g -O2 -nostartfiles -fdiagnostics-format=msvc {{#linkFlags}}-Wl,{{{.}}} {{/linkFlags}} -Wl,-T {{env.LDSCRIPT}} {{#ext.libPaths}}-L{{{.}}} {{/ext.libPaths}} {{#libPaths}}-L{{{.}}} {{/libPaths}} -fuse-ld=lld.exe -Wl,--start-group {{#libs}}-l{{{.}}} {{/libs}} {{#ext.libs}}-l{{{.}}} {{/ext.libs}} -Wl,--end-group {{#objectFiles}}{{{.}}} {{/objectFiles}} -Wl,-Bstatic {{#engineLibs}}-l{{{.}}} {{/engineLibs}}',
                     'mono {{env.MAKENSO}} {{tgt}}.nss {{tgt}}.nso']
    libCmd:         'wine {{env.AR}} rcs {{tgt}} {{#objs}}{{.}} {{/objs}}'
    manifestName:     'Application.nmeta'
    # Manifest merging for switch isn't supported yet
    #manifestMergeCmd: 'java -jar {{env.MANIFEST_MERGE_TOOL}} --platform {{platform}} --main {{mainManifest}} {{#libraries}} --lib {{.}} {{/libraries}} --out {{target}}'
    manifestMergeCmd: 'cp -v {{mainManifest}} {{target}}'
