<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
    <title>Emscripten-Generated Code</title>
    <style>
      object {
        display: none;
      }
      body {
        font-family: arial;
        margin: 0;
        padding: none;
        width: 100%;
        height: 100%;
      }

      /* the canvas *must not* have any border or padding, or mouse coords will be wrong */
      canvas.emscripten { margin: 0 auto; display: block; }

      #status {
        display: none;
        vertical-align: top;
        margin-top: 30px;
        margin-left: 12px;
        font-weight: bold;
        color: rgb(120, 120, 120);
        text-align:left;
      }

      #progress {
        vertical-align: top;
        margin-top: 30px;
        height: 20px;
      }

      #output {
        width: 100%;
        height: 200px;
        margin: 0 auto;
        margin-top: 10px;
        display: block;
        background-color: black;
        color: white;
        font-family: 'Lucida Console', Monaco, monospace;
        outline: none;
      }
    </style>
  </head>
  <body>
    <div id="fb-root"></div>

    <div class="spinner" id='spinner'></div>
    <div class="emscripten" id="status">Downloading...</div>
    <progress value="0" max="100" id="progress" hidden=1></progress>

    <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()"></canvas>

    <script type='text/javascript' src="combine.js"></script>
    <script type='text/javascript'>
      var statusElement = document.getElementById('status');
      var progressElement = document.getElementById('progress');
      var spinnerElement = document.getElementById('spinner');

      var Module = {

        'noInitialRun': true,
        'preRunTasks': [],
        'preRunTasksCompleted': 0,
        'mountPoint': '/data',

        _pendingFiles: [],
        _totalFiles: 0,
        _mountedFiles: 0,
        _allPreloaded: false,

        'initialiseScript': function() {
            this['registerBootstrapTask'](Module.mountFilesystem);
            this['registerBootstrapTask'](Module.waitForArchive);
            Combine['addCombineCompletedListener'](Module.onFilePreloaded);
            Combine['addAllTargetsBuiltListener'](Module.onAllFilesPreloaded);
            Combine['addProgressListener'](Module.onPreloadProgress);
            Combine['process']('split/preload_files.json', Module.onPreloadDescriptionProcessed);
            this.setStatus('Downloading...');
        },

        onPreloadProgress: function(downloaded, total) {
            progressElement.value = downloaded;
            progressElement.max = total;
            progressElement.hidden = false;
        },

        onPreloadDescriptionProcessed: function(totalFiles) {
            Module._totalFiles = totalFiles;
        },

        onFilePreloaded: function(name, data) {
            Module.mountFile(name, data, true);
        },

        onAllFilesPreloaded: function() {
            Module._allPreloaded = true;
            var fsCreate = Module['FS_createPreloadedFile'];
            if (typeof fsCreate != 'undefined') {
            	if (0 < Module._pendingFiles.length) {
            		Module.mountPendingFiles();
            	} else {
            		Combine['cleanUp']();
            		Module.onBootstrapTaskCompleted();
            	}
            }
            progressElement.hidden = true;
        },

        mountFile: function(name, data, permitPending) {
            var fsCreate = Module['FS_createPreloadedFile'];
            if (typeof fsCreate != 'undefined') {
                fsCreate(name, null, data, true, true,
                    function() {
                        ++Module._mountedFiles;
                        if (Module._allPreloaded && Module._mountedFiles == Module._totalFiles) {
                            Combine['cleanUp']();
                            Module.onBootstrapTaskCompleted();
                        }
                    },
                    function() {
                         Module.printErr("FAILED TO MOUNT: " + name);
                    },
                    false, true);
            } else {
                if (permitPending) {
                    this._pendingFiles.push({path: name, data: data});
                } else {
                    throw "FS unavailable";
                }
            }
        },

        waitForArchive: function() {
            if (Module._totalFiles > Module._mountedFiles) {
            	Module.mountPendingFiles();
            }
        },

        mountPendingFiles: function() {
        	for (i=0; i<Module._pendingFiles.length; ++i) {
        		item = Module._pendingFiles[i];
                Module.mountFile(item.path, item.data, false);
        	}
        	Module._pendingFiles = [];
        },

        'preRun': [function() {
            var bootstrap = Module['preRunTasks'];
            var i;
            for (i=0; i<bootstrap.length; ++i) {
                bootstrap[i]();
            }
        }],

        onBootstrapTaskCompleted: function() {
            ++Module['preRunTasksCompleted'];
            if (Module['preRunTasksCompleted'] == Module['preRunTasks'].length) {
            	Module.attemptLaunch();
            }
        },

        attemptLaunch: function() {
            if (this.remainingDependencies == 0 && Module['preRunTasksCompleted'] == Module['preRunTasks'].length) {
                Module['callMain']();
            }
        },

        'registerBootstrapTask': function(fn) {
            Module['preRunTasks'].push(fn);
        },

        mountFilesystem: function() {
            FS.mkdir('/data');
            FS.mount(IDBFS, {}, Module['mountPoint']);
            FS.syncfs(true, function(err) {
                assert(!err);
                Module.onBootstrapTaskCompleted();
            });

            // Might it be that emscripten will do much the same as this one day?
            // We should check future versions and remove our patch if it becomes redundant.
            if (typeof _fsync != 'undefined') {
                _old_fsync = _fsync;
                _fsync = function(fd) {
                    ret = _old_fsync(fd);
                    if (ret == 0) {
                        FS.syncfs(false, function(err) { assert(!err); });
                    }
                    return ret;
                }
            }
        },

        postRun: [],
        print: (function() {
          var element = document.getElementById('output');
          if (element) element.value = ''; // clear browser cache
          return function(text) {
            text = Array.prototype.slice.call(arguments).join(' ');
            // These replacements are necessary if you render to raw HTML
            //text = text.replace(/&/g, "&amp;");
            //text = text.replace(/</g, "&lt;");
            //text = text.replace(/>/g, "&gt;");
            //text = text.replace('\n', '<br>', 'g');
            console.log(text);
            if (element) {
              element.value += text + "\n";
              element.scrollTop = element.scrollHeight; // focus on bottom
            }
          };
        })(),
        printErr: function(text) {
          text = Array.prototype.slice.call(arguments).join(' ');
          if (0) { // XXX disabled for safety typeof dump == 'function') {
            dump(text + '\n'); // fast, straight to the real console
          } else {
            console.error(text);
          }
        },
        canvas: document.getElementById('canvas'),
        setStatus: function(text) {
          if (!Module.setStatus.last) Module.setStatus.last = { time: Date.now(), text: '' };
          if (text === Module.setStatus.text) return;
          var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
          var now = Date.now();
          if (m && now - Module.setStatus.last.time < 30) return; // if this is a progress update, skip it if too soon
          if (m) {
            text = m[1];
            progressElement.value = parseInt(m[2])*100;
            progressElement.max = parseInt(m[4])*100;
            progressElement.hidden = false;
            spinnerElement.hidden = false;
          } else {
            progressElement.value = null;
            progressElement.max = null;
            progressElement.hidden = true;
            if (!text) spinnerElement.style.display = 'none';
          }
          statusElement.innerHTML = text;
          Module.setStatus.last.time = Date.now();
        },
        totalDependencies: 0,
        remainingDependencies: 0,
        monitorRunDependencies: function(left) {
          this.totalDependencies = Math.max(this.totalDependencies, left);
          this.remainingDependencies = left;
          if (0 == left) {
            Module.attemptLaunch();
          }
          Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
        }
      };
        Module['initialiseScript']();

      window.onerror = function() {
        Module.setStatus('Exception thrown, see JavaScript console');
        spinnerElement.style.display = 'none';
        Module.setStatus = function(text) {
          if (text) Module.printErr('[post-exception status] ' + text);
        };
      };
    </script>
    <script type="text/javascript" src="//connect.facebook.net/en_US/sdk.js"></script>
    <script type="text/javascript" src="modernizr.custom.js"></script>
    <script type="text/javascript">
    <!-- We see write errors when using this shim on Safari. -->
    Modernizr.load([{
        test: Modernizr.indexedDB,
        nope: 'IndexedDBShim.min.js',
        load: 'Keyword.js'
    }]);
    </script>
  </body>
</html>
