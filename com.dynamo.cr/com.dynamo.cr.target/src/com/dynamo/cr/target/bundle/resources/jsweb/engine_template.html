<!doctype html>
<!--
<html lang="en-us" manifest="${DMENGINE_MANIFEST}$">
-->
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
    <title>${DMENGINE_APP_TITLE}$</title>
    <style>
      body {
        font-family: arial;
        margin: 0;
        padding: none;
        width: 100%;
        height: 100%;
      }

      object {
      	display: none;
      }

      .fullscreenControl {
        position: absolute;
        left: 0px;
        top: 0px;
        z-index: 1;
      }

      .download_modal_container {
      	position: absolute;
      	width: 100%;
      	height: 100%;
      	z-index: 2;
      }

      .absolute-centre {
      	margin: auto;
      	position: absolute;
      	top: 0; left: 0; bottom: 0; right: 0;
      }

      .download_modal_content {
      	width: 50%;
      	height: 50%;
      	background-color: rgb(215, 215, 215);
      }

      .dev_depth {
      	z-index: 1000;
      }

      .emscripten { padding-right: 0; margin-left: auto; margin-right: auto; display: block; }
      div.emscripten { text-align: center; }
      div.emscripten_border { border: 1px solid black; }
      /* the canvas *must not* have any border or padding, or mouse coords will be wrong */
      canvas.emscripten { margin: 0 auto; display: block; }

      #statusDiv {
        vertical-align: top;
        text-align: center;

        font-weight: bold;
        color: rgb(120, 120, 120);
      }

      .statusOffset {
      	top: 50%;
      	margin-top: 40px;
      }

      #progress {
        height: 20px;
      }

      #controls {
        display: inline-block;
        float: right;
        vertical-align: top;
        margin-top: 30px;
        margin-right: 20px;
      }

      #output {
        width: 100%;
        height: 200px;
        margin: 0 auto;
        margin-top: 10px;
        display: block;
        background-color: black;
        color: white;
        font-family: 'Lucida Console', Monaco, monospace;
        outline: none;
      }
    </style>
  </head>
  <body>
    <div id="fb-root"></div>

    <div class="fullscreenControl">
    	<span id='controls'>
		  <span><input type="checkbox" id="resize">Resize canvas</span>
		  <span><input type="checkbox" id="pointerLock" checked>Lock/hide mouse pointer &nbsp;&nbsp;&nbsp;</span>
		  <span><input type="button" value="Fullscreen" onclick="Module.requestFullScreen(document.getElementById('pointerLock').checked,
		                                                                            document.getElementById('resize').checked)"></span>
	    </span>
    </div>

    <div class="download_modal_container" id="dlModal">
    	<div class="download_modal_content absolute-centre emscripten_border">
	    	<div class="emscripten absolute-centre" id="statusDiv"><span id="status" class="statusOffset absolute-centre">Downloading...</span></div>
	    	<progress class="absolute-centre" value="0" max="100" id="progress"></progress>
    	</div>
	</div>

    <div class="emscripten_border">
      <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()"></canvas>
    </div>

    <script type='text/javascript' src="combine.js"></script>
    <script type='text/javascript'>
    	var preloadModal = document.getElementById('dlModal');
    	var statusElement = document.getElementById('status');
    	var progressElement = document.getElementById('progress');
    	var spinnerElement = document.getElementById('spinner');

      var Module = {
      	${DMENGINE_STACK_SIZE}$

        'noInitialRun': true,
        'preRunTasks': [],
        'preRunTasksCompleted': 0,

        _pendingFiles: [],
        _totalFiles: 0,
        _mountedFiles: 0,
        _allPreloaded: false,

        'initialiseScript': function() {
            this['registerBootstrapTask'](Module.mountFilesystem);
            this['registerBootstrapTask'](Module.waitForArchive);
            Combine['addCombineCompletedListener'](Module.onFilePreloaded);
            Combine['addAllTargetsBuiltListener'](Module.onAllFilesPreloaded);
            Combine['addProgressListener'](Module.onPreloadProgress);
            Combine['process']('${DMENGINE_SPLIT}$', Module.onPreloadDescriptionProcessed);
            this.setStatus('Downloading...');
        },

        onPreloadProgress: function(downloaded, total) {
            progressElement.value = downloaded;
            progressElement.max = total;
        },

        onPreloadDescriptionProcessed: function(totalFiles) {
            Module._totalFiles = totalFiles;
        },

        onFilePreloaded: function(name, data) {
            Module.mountFile(name, data, true);
        },

        onAllFilesPreloaded: function() {
            Module._allPreloaded = true;
            var fsCreate = Module['FS_createPreloadedFile'];
            if (typeof fsCreate != 'undefined') {
            	if (0 < Module._pendingFiles.length) {
            		Module.mountPendingFiles();
            	} else {
            		Combine['cleanUp']();
            		Module.onBootstrapTaskCompleted();
            	}
            }
            preloadModal.hidden = true;
        },

        mountFile: function(name, data, permitPending) {
            var fsCreate = Module['FS_createPreloadedFile'];
            if (typeof fsCreate != 'undefined') {
                fsCreate(name, null, data, true, true,
                    function() {
                        ++Module._mountedFiles;
                        if (Module._allPreloaded && Module._mountedFiles == Module._totalFiles) {
                            Combine['cleanUp']();
                            Module.onBootstrapTaskCompleted();
                        }
                    },
                    function() {
                         Module.printErr("FAILED TO MOUNT: " + name);
                    },
                    false, true);
            } else {
                if (permitPending) {
                    this._pendingFiles.push({path: name, data: data});
                } else {
                    throw "FS unavailable";
                }
            }
        },

        waitForArchive: function() {
            if (Module._totalFiles > Module._mountedFiles) {
            	Module.mountPendingFiles();
            }
        },

        mountPendingFiles: function() {
        	for (var i=0; i<Module._pendingFiles.length; ++i) {
        		var item = Module._pendingFiles[i];
                Module.mountFile(item.path, item.data, false);
        	}
        	Module._pendingFiles = [];
        },

        'preRun': [function() {
            var bootstrap = Module['preRunTasks'];
            var i;
            for (i=0; i<bootstrap.length; ++i) {
                bootstrap[i]();
            }
        }],

        onBootstrapTaskCompleted: function() {
            ++Module['preRunTasksCompleted'];
            if (Module['preRunTasksCompleted'] == Module['preRunTasks'].length) {
            	Module.attemptLaunch();
            }
        },

        attemptLaunch: function() {
            if (this.remainingDependencies == 0 && Module['preRunTasksCompleted'] == Module['preRunTasks'].length) {
                Module['callMain']();
            }
        },

        'registerBootstrapTask': function(fn) {
            Module['preRunTasks'].push(fn);
        },

		_indexedDBAvailable: true,
        onUnsupportedIndexedDB: function() {
        	Module._indexedDBAvailable = false;
        },

        mountFilesystem: function() {
        	var dir = DMSYS.GetUserPersistentDataRoot();
            FS.mkdir(dir);

            if (Module._indexedDBAvailable) {
	            FS.mount(IDBFS, {}, dir);
	            FS.syncfs(true, function(err) {
	            	// This operation will fail if the user is running a private browsing session.
	            	// Since the user is explicit about not wanting data to persist, there's nothing to do
	            	// here other than roll over.
	                // assert(!err);
	                Module.onBootstrapTaskCompleted();
	            });
            } else {
				Module.onBootstrapTaskCompleted();
            }

            // Sync IDBFS on fclose.
            if (Module.indexedDBAvailable && typeof _fsync != 'undefined') {
                var _old_fsync = _fsync;
                _fsync = function(fd) {
                    var ret = _old_fsync(fd);
                    if (ret == 0) {
                        FS.syncfs(false, function(err) { });
                    }
                    return ret;
                }
            }
        },

        postRun: [],

        print: function(text) { console.log(text); },
        printErr: function(text) { console.error(text); },

        canvas: document.getElementById('canvas'),
        setStatus: function(text) {
          if (!Module.setStatus.last) Module.setStatus.last = { time: Date.now(), text: '' };
          if (text === Module.setStatus.text) return;
          var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
          var now = Date.now();
          if (m && now - Module.setStatus.last.time < 30) return; // if this is a progress update, skip it if too soon
          if (m) {
            text = m[1];
            progressElement.value = parseInt(m[2])*100;
            progressElement.max = parseInt(m[4])*100;
            progressElement.hidden = false;
          }
          statusElement.innerHTML = text;
          Module.setStatus.last.time = Date.now();
        },
        totalDependencies: 0,
        remainingDependencies: 0,
        monitorRunDependencies: function(left) {
          this.totalDependencies = Math.max(this.totalDependencies, left);
          this.remainingDependencies = left;
          if (0 == left) {
            Module.attemptLaunch();
          }
          Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
        }
      };
      Module['initialiseScript']();

      window.onerror = function() {
        Module.setStatus('Exception thrown, see JavaScript console');
        spinnerElement.style.display = 'none';
        Module.setStatus = function(text) {
          if (text) Module.printErr('[post-exception status] ' + text);
        };
      };
    </script>
    <script type="text/javascript" src="//connect.facebook.net/en_US/sdk.js"></script>
    <script type="text/javascript" src="modernizr.custom.js"></script>
    <script type="text/javascript">
    <!-- We see a bug on first run and write errors when using the shim on Safari. -->
    Modernizr.load([{
        test: Modernizr.indexedDB,
        nope: Module.onUnsupportedIndexedDB,
        load: '${DMENGINE_JS}$'
    }]);
    </script>
  </body>
</html>
