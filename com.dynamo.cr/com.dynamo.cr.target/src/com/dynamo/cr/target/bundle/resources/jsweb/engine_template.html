<!doctype html>
<!--
<html lang="en-us" manifest="${DMENGINE_MANIFEST}$">
-->
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
    <title>${DMENGINE_APP_TITLE}$</title>
    <link rel="stylesheet" type="text/css" href="${DMENGINE_CSS}$"></style>
    ${DMENGINE_DEV_HEAD}$
  </head>
  <body>
    <div id="fb-root"></div>

    <div class="fullscreenControl">
    	<span>
    		<input class="fullscreen" type="button" value="Fullscreen" onclick="Module.requestFullScreen(0,0)">
    	</span>
    </div>

    <div class="download_modal_container" id="dlModal">
    	<div class="download_modal_content absolute-centre splash_border">
			<div class="absolute-centre download_modal_content">
    			<image class="splashImage" src="splash_image.png"></image>
    			<div class="statusText" id="statusDiv"><span id="status" class="statusOffset">Downloading...</span></div>
    			<progress class="gradient" value="0" max="100" id="progress"></progress>
			</div>
    	</div>
	</div>

    <div>
      <canvas class="application" id="canvas" oncontextmenu="event.preventDefault()"></canvas>
    </div>

    <script type='text/javascript' src="combine.js"></script>
    <script type='text/javascript'>
    	var preloadModal = document.getElementById('dlModal');
    	var statusElement = document.getElementById('status');
    	var progressElement = document.getElementById('progress');

      var Module = {
      	${DMENGINE_STACK_SIZE}$

        'noInitialRun': true,
        'preRunTasks': [],
        'preRunTasksCompleted': 0,

        _pendingFiles: [],
        _totalFiles: 0,
        _mountedFiles: 0,
        _allPreloaded: false,

        'initialiseScript': function() {
            this['registerBootstrapTask'](Module.mountFilesystem);
            this['registerBootstrapTask'](Module.waitForArchive);
            Combine['addCombineCompletedListener'](Module.onFilePreloaded);
            Combine['addAllTargetsBuiltListener'](Module.onAllFilesPreloaded);
            Combine['addProgressListener'](Module.onPreloadProgress);
            Combine['process']('${DMENGINE_SPLIT}$', Module.onPreloadDescriptionProcessed);
            this.setStatus('Downloading...');
        },

        onPreloadProgress: function(downloaded, total) {
            progressElement.value = downloaded;
            progressElement.max = total;
        },

        onPreloadDescriptionProcessed: function(totalFiles) {
            Module._totalFiles = totalFiles;
        },

        onFilePreloaded: function(name, data) {
            Module.mountFile(name, data, true);
        },

        onAllFilesPreloaded: function() {
            Module._allPreloaded = true;
            var fsCreate = Module['FS_createPreloadedFile'];
            if (typeof fsCreate != 'undefined') {
            	if (0 < Module._pendingFiles.length) {
            		Module.mountPendingFiles();
            	} else {
            		Combine['cleanUp']();
            		Module.onBootstrapTaskCompleted();
            	}
            }
            preloadModal.hidden = true;
        },

        mountFile: function(name, data, permitPending) {
            var fsCreate = Module['FS_createPreloadedFile'];
            if (typeof fsCreate != 'undefined') {
                fsCreate(name, null, data, true, true,
                    function() {
                        ++Module._mountedFiles;
                        if (Module._allPreloaded && Module._mountedFiles == Module._totalFiles) {
                            Combine['cleanUp']();
                            Module.onBootstrapTaskCompleted();
                        }
                    },
                    function() {
                         Module.printErr("FAILED TO MOUNT: " + name);
                    },
                    false, true);
            } else {
                if (permitPending) {
                    this._pendingFiles.push({path: name, data: data});
                } else {
                    throw "FS unavailable";
                }
            }
        },

        waitForArchive: function() {
            if (Module._totalFiles > Module._mountedFiles) {
            	Module.mountPendingFiles();
            }
        },

        mountPendingFiles: function() {
        	for (var i=0; i<Module._pendingFiles.length; ++i) {
        		var item = Module._pendingFiles[i];
                Module.mountFile(item.path, item.data, false);
        	}
        	Module._pendingFiles = [];
        },

        'preRun': [function() {
            var bootstrap = Module['preRunTasks'];
            var i;
            for (i=0; i<bootstrap.length; ++i) {
                bootstrap[i]();
            }
        }],

        onBootstrapTaskCompleted: function() {
            ++Module['preRunTasksCompleted'];
            if (Module['preRunTasksCompleted'] == Module['preRunTasks'].length) {
            	Module.attemptLaunch();
            }
        },

        attemptLaunch: function() {
            if (this.remainingDependencies == 0 && Module['preRunTasksCompleted'] == Module['preRunTasks'].length) {
                Module['callMain']();
            }
        },

        'registerBootstrapTask': function(fn) {
            Module['preRunTasks'].push(fn);
        },

		_indexedDBAvailable: true,
        onUnsupportedIndexedDB: function() {
        	Module._indexedDBAvailable = false;
        },

        mountFilesystem: function() {
        	var dir = DMSYS.GetUserPersistentDataRoot();
            FS.mkdir(dir);

            if (Module._indexedDBAvailable) {
	            FS.mount(IDBFS, {}, dir);
	            FS.syncfs(true, function(err) {
	            	// This operation will fail if the user is running a private browsing session.
	            	// Since the user is explicit about not wanting data to persist, there's nothing to do
	            	// here other than roll over.
	                // assert(!err);
	                Module.onBootstrapTaskCompleted();
	            });
            } else {
				Module.onBootstrapTaskCompleted();
            }

            // Sync IDBFS on fclose.
            if (Module.indexedDBAvailable && typeof _fsync != 'undefined') {
                var _old_fsync = _fsync;
                _fsync = function(fd) {
                    var ret = _old_fsync(fd);
                    if (ret == 0) {
                        FS.syncfs(false, function(err) { });
                    }
                    return ret;
                }
            }
        },

        postRun: [],

        print: function(text) { console.log(text); },
        printErr: function(text) { console.error(text); },

        canvas: document.getElementById('canvas'),
        setStatus: function(text) {
          if (!Module.setStatus.last) Module.setStatus.last = { time: Date.now(), text: '' };
          if (text === Module.setStatus.text) return;
          var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
          var now = Date.now();
          if (m && now - Module.setStatus.last.time < 30) return; // if this is a progress update, skip it if too soon
          if (m) {
            text = m[1];
            progressElement.value = parseInt(m[2])*100;
            progressElement.max = parseInt(m[4])*100;
            progressElement.hidden = false;
          }
          if (text && 0 < text.length) {
          	statusElement.innerHTML = text;
          }
          Module.setStatus.last.time = Date.now();
        },
        totalDependencies: 0,
        remainingDependencies: 0,
        monitorRunDependencies: function(left) {
          this.totalDependencies = Math.max(this.totalDependencies, left);
          this.remainingDependencies = left;
          if (0 == left) {
            Module.attemptLaunch();
          }
          Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
        }
      };
      Module['initialiseScript']();

      window.onerror = function() {
        Module.setStatus('Exception thrown, see JavaScript console');
        Module.setStatus = function(text) {
          if (text) Module.printErr('[post-exception status] ' + text);
        };
      };
    </script>
    ${DMENGINE_DEV_INLINE}$
    <script type="text/javascript" src="//connect.facebook.net/en_US/sdk.js"></script>
    <script type="text/javascript" src="modernizr.custom.js"></script>
    <script type="text/javascript">
    <!-- We see a bug on first run and write errors when using the shim on Safari. -->
    Modernizr.load([{
        test: Modernizr.indexedDB,
        nope: Module.onUnsupportedIndexedDB,
        load: '${DMENGINE_JS}$'${DMENGINE_DEV_INIT}$
    }]);
    </script>
  </body>
</html>
